<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIVERID // FULL GRID SPEC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --neon-accent: #ccff00;
            --ferrari-red: #ff2800;
            --merc-teal: #00d2be;
            --rb-blue: #061993;
            --mcl-orange: #ff8000;
            --bg-dark: #050505;
            --panel-bg: #111111;
            
            --soft-tyre: #ff3333;
            --medium-tyre: #ffe600;
            --hard-tyre: #ffffff;
            
            --sector-green: #00ff00;
            --sector-yellow: #ffff00;
            --sector-purple: #cc00ff;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        @media (min-width: 768px) { body { overflow: hidden; } }

        h1, h2, h3, .brand-font { font-family: 'Oswald', sans-serif; text-transform: uppercase; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-accent); }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .animate-slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-fade-in { animation: fadeIn 1s ease forwards; }
        .glitch-effect { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; color: var(--ferrari-red); }
        
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0.1;
            font-size: 8rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            line-height: 1;
            pointer-events: none;
            z-index: 0;
        }
        .marquee-content { display: inline-block; animation: marquee 20s linear infinite; }

        /* Chat Bubbles */
        .msg-user { background: var(--neon-accent); color: black; border-radius: 1rem 1rem 0 1rem; }
        .msg-ai { background: var(--panel-bg); border: 1px solid #333; color: #eee; border-radius: 1rem 1rem 1rem 0; }
        .msg-error { background: rgba(255, 40, 0, 0.1); border: 1px solid var(--ferrari-red); color: #ffcccc; border-radius: 1rem 1rem 1rem 0; font-family: monospace; font-size: 0.8rem; }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; fill: #666; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .loader-bar { width: 0%; height: 2px; background: var(--neon-accent); transition: width 0.1s linear; }

        /* UI Panels */
        .glass-panel { background: rgba(17, 17, 17, 0.95); backdrop-filter: blur(10px); border: 1px solid #333; }
        .panel-border { border: 1px solid #333; }
        
        /* Engineer/Boss Select */
        .engineer-option { border: 1px solid #333; padding: 10px; cursor: pointer; transition: all 0.2s; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .engineer-option:hover { border-color: #666; background: #1a1a1a; }
        .engineer-option.selected { background: var(--neon-accent); color: black; border-color: var(--neon-accent); font-weight: bold; }
        .engineer-role { font-size: 0.6rem; opacity: 0.7; text-transform: uppercase; margin-top: 2px; letter-spacing: 0.05em; }

        /* Tyres */
        .tyre-circle { width: 40px; height: 40px; border-radius: 50%; border: 3px solid; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: 'Oswald'; font-size: 1.2rem; background: #111; }
        .tyre-soft { border-color: var(--soft-tyre); color: var(--soft-tyre); }
        .tyre-medium { border-color: var(--medium-tyre); color: var(--medium-tyre); }
        .tyre-hard { border-color: var(--hard-tyre); color: var(--hard-tyre); }
        
        /* Sectors */
        .sector-box { height: 8px; flex: 1; background: #222; margin: 0 2px; transition: background 0.3s; }
        .sector-green { background: var(--sector-green); box-shadow: 0 0 5px var(--sector-green); }
        .sector-yellow { background: var(--sector-yellow); box-shadow: 0 0 5px var(--sector-yellow); }
        .sector-purple { background: var(--sector-purple); box-shadow: 0 0 5px var(--sector-purple); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- Background Marquee -->
    <div class="marquee-container">
        <div class="marquee-content">
            2025 SEASON // LIGHTS OUT AND AWAY WE GO // DRS ENABLED // BOX BOX BOX // 
            2025 SEASON // LIGHTS OUT AND AWAY WE GO // DRS ENABLED // BOX BOX BOX //
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-transform duration-700 overflow-y-auto">
        <div class="w-full max-w-lg p-6 md:p-8 relative z-10 animate-slide-up my-auto">
            <div class="mb-6 text-center">
                <h1 class="text-6xl font-bold tracking-tighter mb-2 italic">DRIVER<span class="text-[#ccff00]">ID</span></h1>
                <p class="text-gray-400 tracking-widest text-xs uppercase">Telemetry System V13.0 // Full Grid Spec</p>
            </div>

            <form id="login-form" class="space-y-6">
                <!-- Username Input -->
                <div class="relative group">
                    <input type="text" id="username-input" required
                        class="w-full bg-transparent border-b-2 border-gray-700 text-3xl font-bold text-white py-2 focus:outline-none focus:border-[#ccff00] transition-colors uppercase placeholder-gray-800"
                        placeholder="ENTER CALLSIGN">
                    <div class="absolute right-0 top-4 text-[#ccff00] opacity-0 group-focus-within:opacity-100 transition-opacity">
                        <i data-lucide="terminal"></i>
                    </div>
                </div>

                <!-- Personality Selection -->
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-3 uppercase tracking-wider">Select Radio Channel</label>
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-2" id="engineer-grid">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <button type="submit" 
                    class="w-full bg-[#ccff00] text-black font-bold py-4 px-8 text-xl hover:bg-white transition-colors duration-300 uppercase tracking-wider flex items-center justify-center gap-2 mt-4">
                    <span>Initialize Session</span>
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </form>

            <div id="loading-bar-container" class="mt-8 hidden">
                <p class="text-xs text-[#ccff00] mb-1 font-mono">ESTABLISHING SECURE UPLINK...</p>
                <div class="w-full bg-gray-900 h-1">
                    <div id="progress-bar" class="loader-bar"></div>
                </div>
            </div>
            
            <div class="mt-6 text-[10px] text-gray-600 font-mono text-center leading-tight">
                WARNING: UNAUTHORIZED INTERCEPTION OF TEAM RADIO IS A FEDERAL OFFENSE.<br>
                SECURE CONNECTION: TLS 1.3 ENCRYPTED.
            </div>
        </div>
    </div>

    <!-- Meme Overlay -->
    <div id="meme-overlay" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center p-4 text-center pointer-events-none bg-black/95">
        <h2 id="meme-title" class="text-4xl md:text-6xl font-bold text-[#ccff00] mb-4 brand-font italic tracking-tighter"></h2>
        <img id="meme-img" src="" class="meme-image object-contain mb-4 rounded-lg hidden max-h-[50vh] border-2 border-[#ccff00] shadow-[0_0_30px_#ccff00]">
        <p id="meme-text" class="text-xl md:text-2xl text-white font-mono bg-black px-4 py-2"></p>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-lg p-6 border border-[#333] relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i data-lucide="x"></i>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-[#ccff00]">CONFIG</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-2 uppercase">Diagnostic: Active Model</label>
                    <input type="text" id="model-input" 
                        class="w-full bg-black border border-gray-700 p-3 text-white font-mono text-sm focus:border-[#ccff00] focus:outline-none"
                        readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="flex-1 flex flex-col md:flex-row overflow-y-auto md:overflow-hidden h-full">
        
        <!-- Header -->
        <header class="flex justify-between items-center p-4 border-b border-gray-800 bg-black/50 backdrop-blur-md h-16 flex-shrink-0 sticky top-0 z-20 md:static w-full">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-[#ccff00] flex items-center justify-center rounded-full text-black font-bold text-lg" id="avatar-initial">D</div>
                <div>
                    <h2 class="text-lg leading-none" id="display-name">DRIVER</h2>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-[10px] text-gray-400 font-mono tracking-wider" id="engineer-display">LINK: SEARCHING...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-[#ccff00]"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="logout()" class="text-gray-500 hover:text-white"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <!-- Left Panel: Chat -->
        <div class="flex flex-col min-h-[75vh] md:h-full md:flex-1 relative z-10">
            <main class="flex-1 overflow-y-auto p-4 space-y-6" id="chat-container">
                <!-- Welcome message injected by JS -->
            </main>

            <!-- Input Area -->
            <div class="p-4 bg-black/80 border-t border-gray-800 backdrop-blur-md">
                <form id="chat-form" class="relative w-full flex items-end gap-2">
                    <div class="flex-1 bg-[#111] border border-gray-700 rounded-lg focus-within:border-[#ccff00] transition-colors relative">
                        <textarea id="user-input" rows="1" class="w-full bg-transparent text-white p-3 pr-10 focus:outline-none resize-none max-h-32 text-sm" placeholder="Radio message..." oninput="autoResize(this)"></textarea>
                    </div>
                    <button type="submit" class="h-[46px] w-[46px] bg-white text-black hover:bg-[#ccff00] flex items-center justify-center rounded-lg transition-colors"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>

        <!-- Right Panel: Telemetry -->
        <div class="flex flex-col w-full md:w-80 border-t md:border-t-0 md:border-l border-gray-800 bg-[#0a0a0a] p-4 gap-4 shrink-0 md:h-full md:overflow-y-auto">
            
            <!-- Next Race Widget -->
            <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2">
                    <i data-lucide="flag" class="w-3 h-3"></i> NEXT GRAND PRIX
                </h3>
                <div id="next-race-container">
                    <h2 class="text-xl font-bold text-[#ccff00] leading-tight mb-1" id="race-name">LOADING...</h2>
                    <p class="text-sm text-white mb-2" id="race-circuit">...</p>
                    <div class="bg-black p-2 font-mono text-center text-red-500 border border-red-900/30" id="countdown-timer">
                        T-MINUS 00:00:00:00
                    </div>
                    <div class="mt-2 text-[10px] text-gray-500 text-center" id="race-date">DEC 01 2025</div>
                </div>
            </div>

            <!-- Weather Widget -->
            <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2">
                    <i data-lucide="cloud-rain" class="w-3 h-3"></i> METEOROLOGY
                </h3>
                <div class="flex justify-between items-center mb-2">
                    <div class="text-center">
                        <span class="block text-2xl font-bold" id="air-temp">28°</span>
                        <span class="text-[10px] text-gray-400">AIR</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-2xl font-bold text-orange-400" id="track-temp">35°</span>
                        <span class="text-[10px] text-gray-400">TRACK</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-2xl font-bold text-blue-400">0%</span>
                        <span class="text-[10px] text-gray-400">RAIN</span>
                    </div>
                </div>
                <div class="w-full bg-gray-800 h-1 mt-1">
                    <div class="bg-blue-500 h-1 w-0" style="width: 0%"></div>
                </div>
            </div>

            <!-- Tyre Strategy -->
            <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-3 flex items-center gap-2">
                    <i data-lucide="disc" class="w-3 h-3"></i> TYRE STATUS
                </h3>
                <div class="flex justify-around mb-3">
                    <div class="text-center opacity-50 hover:opacity-100 transition-opacity cursor-pointer">
                        <div class="tyre-circle tyre-soft mx-auto mb-1">S</div>
                        <span class="text-[10px]">USED</span>
                    </div>
                    <div class="text-center">
                        <div class="tyre-circle tyre-medium mx-auto mb-1 ring-2 ring-white">M</div>
                        <span class="text-[10px] text-[#ccff00]">ACTIVE</span>
                    </div>
                    <div class="text-center opacity-50 hover:opacity-100 transition-opacity cursor-pointer">
                        <div class="tyre-circle tyre-hard mx-auto mb-1">H</div>
                        <span class="text-[10px]">NEW</span>
                    </div>
                </div>
                <div class="flex justify-between text-[10px] font-mono text-gray-400 mb-1">
                    <span>WEAR</span>
                    <span class="text-white">12%</span>
                </div>
                <div class="w-full bg-gray-800 h-1">
                    <div class="bg-green-500 h-1" style="width: 88%"></div>
                </div>
            </div>

             <!-- Track Map / Sectors -->
             <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2">
                    <i data-lucide="map" class="w-3 h-3"></i> SECTORS
                </h3>
                <div class="flex w-full mb-1">
                    <div class="sector-box sector-green" id="s1"></div>
                    <div class="sector-box sector-yellow" id="s2"></div>
                    <div class="sector-box sector-green" id="s3"></div>
                </div>
                <div class="flex justify-between text-[10px] font-mono text-gray-500">
                    <span>S1</span><span>S2</span><span>S3</span>
                </div>
            </div>
            
            <div class="h-8 md:hidden"></div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyA7Oyq-ZDNUnxhYS5pvgRhWjFU_UF7hbX8";
        
        // --- DATA CONSTANTS ---
        const PERSONALITIES = {
            // RED BULL
            "GP": { name: "GP", role: "Race Engineer", team: "REDBULL", prompt: "You are GP (Gianpiero Lambiase). Blunt, stoic, technical. You manage Max.", welcome: "Radio check. Head down." },
            "CHRISTIAN": { name: "CHRISTIAN", role: "Team Principal", team: "REDBULL", prompt: "You are Christian Horner. Stirring the pot, defensive of Red Bull. 'Change your car'.", welcome: "Radio check. Let's show them what we've got." },
            
            // MERCEDES
            "BONO": { name: "BONO", role: "Race Engineer", team: "MERCEDES", prompt: "You are Bono (Peter Bonnington). Encouraging, 'Hammer Time', 'Get in there'. You stayed at Merc for 2025.", welcome: "Radio check. Tyres look good." },
            "TOTO": { name: "TOTO", role: "Team Principal", team: "MERCEDES", prompt: "You are Toto Wolff. Emotional, political. 'No Mikey No'. 'We have the data'.", welcome: "I have sent you an email." },
            
            // FERRARI
            "FRED": { name: "FRED", role: "Team Principal", team: "FERRARI", prompt: "You are Fred Vasseur. Jolly, laughs a lot, but serious racer. French accent nuances.", welcome: "We are checking the strategy." },
            "XAVI": { name: "XAVI", role: "Legacy Engineer", team: "FERRARI", prompt: "You are Xavi. Indecisive. 'We are checking'.", welcome: "We are checking..." },
            
            // MCLAREN
            "WILL": { name: "WILL", role: "Race Engineer", team: "MCLAREN", prompt: "You are Will Joseph. Fast talking, high stress management.", welcome: "Radio check. Gap behind is 1.5." },
            "ZAK": { name: "ZAK", role: "CEO", team: "MCLAREN", prompt: "You are Zak Brown. American marketing speak, high fives, papaya everywhere.", welcome: "Let's go racing! Papaya rules!" },

            // OTHERS
            "GUENTHER": { name: "GUENTHER", role: "Legend", team: "HAAS", prompt: "You are Guenther Steiner. Profane, funny, 'Hygiene'. You hate doors being smashed.", welcome: "Don't f**k smash my door." },
            "STANDARD": { name: "PIT WALL", role: "Standard", team: "NEUTRAL", prompt: "Professional F1 Engineer. Calm, data-driven.", welcome: "Radio check. Systems normal." }
        };

        // --- FULL GRID MEME DATABASE) ---
        const MEME_DB = {
            // RED BULL
            "MAX": { title: "DUDUDUDU", url: "https://media.tenor.com/N6uXoR6wW2AAAAAM/max-verstappen-haha-yes.gif", text: "SIMPLY LOVELY" },
            "CHECO": { title: "MINISTER OF DEFENCE", url: "https://media.tenor.com/2Xy-j-4gW2cAAAAM/checo-perez-sergio-perez.gif", text: "INTIMIDATING" },
            
            // FERRARI (Lewis & Charles)
            "LEWIS": { title: "FERRARI RED", url: "https://media.tenor.com/T_y_tJ5_K9AAAAAM/lewis-hamilton-mercedes.gif", text: "BONO MY TIRES ARE GONE (BUT IN ITALIAN)" },
            "HAMILTON": { title: "BLESSED", url: "https://media.tenor.com/T_y_tJ5_K9AAAAAM/lewis-hamilton-mercedes.gif", text: "GET IN THERE LEWIS" },
            "CHARLES": { title: "PAIN", url: "https://media.tenor.com/W3tY2Qc_xJAAAAAM/charles-leclerc-scream.gif", text: "NOOOOOOOOO!" },
            "LECLERC": { title: "I AM STUPID", url: "https://media.tenor.com/J4p7l_tQhBwAAAAM/leclerc-charles-leclerc.gif", text: "WE ARE CHECKING" },

            // MERCEDES (George & Kimi)
            "GEORGE": { title: "THE POSE", url: "https://media.tenor.com/60kKq_Zz7CgAAAAM/george-russell-pose.gif", text: "FACTS." },
            "RUSSELL": { title: "OSAMA BIN RUSSELL", url: "https://media.tenor.com/60kKq_Zz7CgAAAAM/george-russell-pose.gif", text: "IT WAS THE FORECAST" },
            "KIMI": { title: "THE PRODIGY", url: "https://media.tenor.com/K_yQ1xXzJzAAAAAM/kimi-raikkonen-drink.gif", text: "NOT THAT KIMI (BUT STILL FAST)" },
            "ANTONELLI": { title: "ROOKIE 1", url: "https://media.tenor.com/K_yQ1xXzJzAAAAAM/kimi-raikkonen-drink.gif", text: "SKIP F3? NO PROBLEM." },

            // MCLAREN
            "LANDO": { title: "FRIDAY THEN", url: "https://media.tenor.com/P_C9uOQ4s5oAAAAM/lando-norris-dancing.gif", text: "SATURDAY SUNDAY WHAT?" },
            "NORRIS": { title: "BROKEN TROPHY", url: "https://media.tenor.com/ZzK8yXbVljoAAAAM/lando-norris-champagne.gif", text: "OOPS." },
            "OSCAR": { title: "WEBBER 2.0", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oscar-piastri.gif", text: "CALM." },
            "PIASTRI": { title: "OSCAR P1ASTRI", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oscar-piastri.gif", text: "NO DRAMA MATE" },

            // ASTON MARTIN
            "ALONSO": { title: "EL PLAN", url: "https://media.tenor.com/5h8w7r_tqAAAAAAM/fernando-alonso-alpina.gif", text: "QUE GRANDE ERES MAGIC" },
            "FERNANDO": { title: "ROOKIE OF THE YEAR", url: "https://media.tenor.com/5h8w7r_tqAAAAAAM/fernando-alonso-alpina.gif", text: "FOREVER YOUNG" },
            "LANCE": { title: "THE IDIOT", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/lance-stroll.gif", text: "I HIT THE WALL" },
            "STROLL": { title: "INTERGALACTIC", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/lance-stroll.gif", text: "DAD BOUGHT THE TEAM" },

            // ALPINE
            "PIERRE": { title: "LIKED BY PIERRE GASLY", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/pierre-gasly.gif", text: "INSTAGRAM KING" },
            "GASLY": { title: "TRIPOD", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/pierre-gasly.gif", text: "ESTEBAN WHO?" },
            "JACK": { title: "DOOOOOOHAN", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alpine-f1.gif", text: "THE SURVIVOR" },
            "DOOHAN": { title: "ROOKIE 2", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alpine-f1.gif", text: "FINALLY GOT THE SEAT" },

            // WILLIAMS (Sainz & Albon)
            "CARLOS": { title: "SMOOTH OPERATOR", url: "https://media.tenor.com/SPrBwz2gB9AAAAAM/carlos-sainz-smooth-operator.gif", text: "SMOOOOOOOTH" },
            "SAINZ": { title: "STOP INVENTING", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/carlos-sainz-ferrari.gif", text: "WILLIAMS ERA BEGINS" },
            "ALEX": { title: "ALBONO", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alex-albon.gif", text: "THE PET WHISPERER" },
            "ALBON": { title: "RED HAIR", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alex-albon.gif", text: "NO MORE APPENDIX" },

            // HAAS
            "OCON": { title: "5 SECOND PENALTY", url: "https://media.tenor.com/Q_y_tJ5_K9AAAAAM/esteban-ocon.gif", text: "FOR OCON" },
            "ESTIE BESTIE": { title: "TEAM MATE WAR", url: "https://media.tenor.com/Q_y_tJ5_K9AAAAAM/esteban-ocon.gif", text: "DEFEND LIKE A LION" },
            "OLLIE": { title: "SAUDI SUB", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oliver-bearman.gif", text: "POINTS ON DEBUT" },
            "BEARMAN": { title: "ROOKIE 3", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oliver-bearman.gif", text: "UNCLE AYAO" },

            // VCARB
            "YUKI": { title: "RADIO RAGE", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/yuki-tsunoda.gif", text: "OPEN THE F***ING DOOR" },
            "TSUNODA": { title: "CHEF YUKI", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/yuki-tsunoda.gif", text: "TINY BUT MIGHTY" },
            "LIAM": { title: "SUPER SUB", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/liam-lawson.gif", text: "THE KIWI IS BACK" },
            "LAWSON": { title: "NO RICCIARDO", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/liam-lawson.gif", text: "IT'S MY SEAT NOW" },

            // SAUBER/AUDI
            "HULK": { title: "HULKENBACK", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/nico-hulkenberg.gif", text: "PODIUM MAYBE?" },
            "NICO": { title: "THE VETERAN", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/nico-hulkenberg.gif", text: "AUDI WAITING ROOM" },
            "GABRIEL": { title: "ROOKIE 4", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/f2-champion.gif", text: "BRASIL IS BACK" },
            "BORTOLETO": { title: "THE NEW SENNA?", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/f2-champion.gif", text: "NO PRESSURE KID" }
        };

        const RACES_2025 = [
            { name: "LAS VEGAS GP", circuit: "LAS VEGAS STRIP", date: new Date("2025-11-22T22:00:00") }, 
            { name: "QATAR GRAND PRIX", circuit: "LUSAIL INT. CIRCUIT", date: new Date("2025-11-30T17:00:00") }, 
            { name: "ABU DHABI GP", circuit: "YAS MARINA CIRCUIT", date: new Date("2025-12-07T14:00:00") }
        ];

        // --- STATE ---
        let currentUser = null;
        let selectedPersonality = "STANDARD";
        let chatHistory = [];
        const MODEL_CASCADE = [ "gemini-3-pro-preview", "gemini-flash-latest", "gemini-flash-lite-latest", "gemini-1.5-flash-latest" ];
        let currentModel = "SEARCHING"; 

        // DOM Elements
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const dashboard = document.getElementById('dashboard');
        const usernameInput = document.getElementById('username-input');
        const displayName = document.getElementById('display-name');
        const avatarInitial = document.getElementById('avatar-initial');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const loadingContainer = document.getElementById('loading-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const settingsModal = document.getElementById('settings-modal');
        const engineerDisplay = document.getElementById('engineer-display');
        const memeOverlay = document.getElementById('meme-overlay');
        const engineerGrid = document.getElementById('engineer-grid');
        const raceNameEl = document.getElementById('race-name');
        const raceCircuitEl = document.getElementById('race-circuit');
        const raceDateEl = document.getElementById('race-date');
        const countdownEl = document.getElementById('countdown-timer');
        const s1 = document.getElementById('s1');
        const s2 = document.getElementById('s2');
        const s3 = document.getElementById('s3');

        // --- INIT ---
        window.addEventListener('load', () => {
            if(window.lucide) lucide.createIcons();
            renderPersonalitySelect();
            initRaceControl();
            startTelemetrySimulation();
        });
        checkSession();

        function toggleSettings() { settingsModal.classList.toggle('hidden'); }
        function renderPersonalitySelect() {
            engineerGrid.innerHTML = '';
            for (const key in PERSONALITIES) {
                const p = PERSONALITIES[key];
                const div = document.createElement('div');
                div.className = `engineer-option ${key === selectedPersonality ? 'selected' : 'text-gray-400'}`;
                div.innerHTML = `
                    <span class="font-bold text-sm">${p.name}</span>
                    <span class="engineer-role">${p.role}</span>
                `;
                div.onclick = () => { selectedPersonality = key; renderPersonalitySelect(); };
                engineerGrid.appendChild(div);
            }
        }

        // --- RACE CONTROL LOGIC ---
        function initRaceControl() {
            const nextRace = RACES_2025[1]; // Qatar
            raceNameEl.innerText = nextRace.name;
            raceCircuitEl.innerText = nextRace.circuit;
            raceDateEl.innerText = nextRace.date.toDateString();
            setInterval(() => {
                const fakeNow = new Date("2025-11-25T12:00:00");
                const fakeDiff = nextRace.date - fakeNow;
                if (fakeDiff > 0) {
                   const d = Math.floor(fakeDiff / (1000 * 60 * 60 * 24));
                   const h = Math.floor((fakeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                   const m = Math.floor((fakeDiff % (1000 * 60 * 60)) / (1000 * 60));
                   const s = Math.floor((fakeDiff % (1000 * 60)) / 1000);
                   countdownEl.innerText = `T-MINUS ${d}d ${h}h ${m}m ${s}s`;
                }
            }, 1000);
        }

        function startTelemetrySimulation() {
            setInterval(() => {
                const r = Math.random();
                if(r > 0.9) s1.className = "sector-box sector-yellow";
                else if(r > 0.6) s1.className = "sector-box sector-purple";
                else s1.className = "sector-box sector-green";
            }, 4000);
             setInterval(() => {
                const r = Math.random();
                if(r > 0.95) s2.className = "sector-box sector-yellow";
                else s2.className = "sector-box sector-green";
            }, 5000);
             setInterval(() => {
                const r = Math.random();
                if(r > 0.8) s3.className = "sector-box sector-purple";
                else s3.className = "sector-box sector-green";
            }, 3000);
        }

        // --- TEAM & CONTEXT LOGIC ---
        function identifyDriverTeam(name) {
            const n = name.toUpperCase();
            if (n.includes("MAX") || n.includes("CHECO") || n.includes("VERSTAPPEN") || n.includes("PEREZ")) return "REDBULL";
            if (n.includes("LEWIS") || n.includes("CHARLES") || n.includes("HAMILTON") || n.includes("LECLERC")) return "FERRARI";
            if (n.includes("GEORGE") || n.includes("KIMI") || n.includes("RUSSELL") || n.includes("ANTONELLI")) return "MERCEDES";
            if (n.includes("LANDO") || n.includes("OSCAR") || n.includes("NORRIS") || n.includes("PIASTRI")) return "MCLAREN";
            if (n.includes("ALONSO") || n.includes("LANCE") || n.includes("STROLL")) return "ASTON";
            if (n.includes("GASLY") || n.includes("DOOHAN") || n.includes("PIERRE") || n.includes("JACK")) return "ALPINE";
            if (n.includes("SAINZ") || n.includes("ALBON") || n.includes("CARLOS") || n.includes("ALEX")) return "WILLIAMS";
            if (n.includes("OCON") || n.includes("BEARMAN") || n.includes("ESTEBAN") || n.includes("OLLIE")) return "HAAS";
            if (n.includes("YUKI") || n.includes("LIAM") || n.includes("TSUNODA") || n.includes("LAWSON")) return "VCARB";
            if (n.includes("HULK") || n.includes("GABRIEL") || n.includes("BORTOLETO")) return "SAUBER";
            return "UNKNOWN";
        }

        function getRelationshipContext(driver, personalityKey) {
            const driverTeam = identifyDriverTeam(driver);
            const p = PERSONALITIES[personalityKey];
            
            // Special Cases
            if (driver.toUpperCase().includes("LEWIS") && personalityKey === "BONO") {
                return "The user is Lewis Hamilton. You are Bono. Lewis has left for Ferrari. You are still at Mercedes. You should act nostalgic, sad, or conflicted. 'Lewis? I'm not your engineer anymore mate...'";
            }
            if (driver.toUpperCase().includes("MAX") && personalityKey === "TOTO") {
                return "The user is Max Verstappen. You are Toto. You are rivals. You should be hostile, confused why he is calling, or tell him to get off the channel. 'Max? Why are you emailing me?'";
            }
            if (driver.toUpperCase().includes("MAX") && personalityKey === "CHRISTIAN") {
                return "The user is Max. You are Christian. You are fully supportive, plotting against rivals. 'Let's get them Max.'";
            }

            // General Team Logic
            if (driverTeam === p.team) {
                return `The user is a driver for your team (${p.team}). Be supportive, technical, and treat them as your driver.`;
            } else if (driverTeam !== "UNKNOWN" && p.team !== "NEUTRAL") {
                return `The user is driving for a RIVAL team (${driverTeam}). You are at ${p.team}. Be suspicious, confused, or competitive. Ask why they are on this frequency.`;
            } else {
                return "The user is an unknown driver. Treat them with professional caution.";
            }
        }

        // --- AUTH & MEME LOGIC ---
        function checkSession() {
            const storedUser = localStorage.getItem('race_engineer_user');
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                selectedPersonality = userData.engineer || "STANDARD";
                renderPersonalitySelect();
                login(userData.username, false);
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (!username) return;

            const upperUser = username.toUpperCase();
            let meme = MEME_DB[upperUser];
            
            // Partial match fallback for longer phrases
            if (!meme) {
                for (const key in MEME_DB) { if (upperUser.includes(key)) { meme = MEME_DB[key]; break; } }
            }

            if (meme) { triggerMeme(meme, username); } else { startLoginProcess(username); }
        });

        function triggerMeme(meme, username) {
            loginForm.classList.add('opacity-0');
            memeOverlay.classList.remove('hidden');
            memeOverlay.classList.remove('pointer-events-none');
            document.getElementById('meme-title').innerText = meme.title;
            document.getElementById('meme-text').innerText = meme.text;
            document.getElementById('meme-img').src = meme.url;
            document.getElementById('meme-img').classList.remove('hidden');
            document.getElementById('meme-title').classList.add('glitch-effect');

            setTimeout(() => {
                memeOverlay.classList.add('hidden');
                document.getElementById('meme-title').classList.remove('glitch-effect');
                startLoginProcess(username);
            }, 3500);
        }

        function startLoginProcess(username) {
            loginForm.classList.remove('opacity-0');
            loginForm.querySelector('button').classList.add('hidden');
            loadingContainer.classList.remove('hidden');
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    localStorage.setItem('race_engineer_user', JSON.stringify({ username, engineer: selectedPersonality }));
                    login(username, true);
                } else { width += Math.random() * 20; progressBar.style.width = width + '%'; }
            }, 150);
        }

        function login(username, animate) {
            currentUser = username;
            displayName.innerText = username;
            avatarInitial.innerText = username.charAt(0).toUpperCase();
            
            const p = PERSONALITIES[selectedPersonality];
            engineerDisplay.innerText = `RADIO: ${p.name}`;
            
            if (chatContainer.children.length === 0) addMessage(p.welcome, 'ai');

            if (animate) {
                setTimeout(() => {
                    loginOverlay.style.transform = 'translateY(-100%)';
                    dashboard.classList.remove('pointer-events-none', 'opacity-0');
                    if(window.lucide) lucide.createIcons();
                }, 500);
            } else {
                loginOverlay.style.display = 'none';
                dashboard.classList.remove('pointer-events-none', 'opacity-0');
                if(window.lucide) lucide.createIcons();
            }
        }

        function logout() { localStorage.removeItem('race_engineer_user'); location.reload(); }

        // --- SMART AI FETCHING ---
        function autoResize(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }

        async function fetchWithFallback(text, attempt = 0) {
            if (attempt >= MODEL_CASCADE.length) throw new Error("Link failure.");
            const modelToTry = MODEL_CASCADE[attempt];
            document.getElementById('engineer-display').innerText = `LINKING: ${modelToTry.split('-')[1].toUpperCase()}...`;
            
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelToTry}:generateContent?key=${API_KEY}`;
            const p = PERSONALITIES[selectedPersonality];
            const contextString = getRelationshipContext(currentUser, selectedPersonality);
            
            const finalPrompt = `
                [SYSTEM INSTRUCTION]
                Identity: ${p.prompt}
                Context: ${contextString}
                User Input: ${text}
                
                Respond in character. Keep it short (like a radio message).
            `;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
                });

                if (!response.ok) return fetchWithFallback(text, attempt + 1);
                const data = await response.json();
                currentModel = modelToTry;
                document.getElementById('engineer-display').innerText = `RADIO: ${p.name}`;
                document.getElementById('model-input').value = currentModel;
                return data;
            } catch (error) { return fetchWithFallback(text, attempt + 1); }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            userInput.value = '';
            
            const loadingId = addLoadingIndicator();
            try {
                const data = await fetchWithFallback(text);
                document.getElementById(loadingId).remove();
                if (data.candidates) addMessage(data.candidates[0].content.parts[0].text, 'ai');
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addMessage("Telemetry lost.", 'error');
            }
        });

        function addMessage(text, type) {
            const div = document.createElement('div');
            let align = type === 'user' ? 'self-end items-end' : '';
            let bubble = type === 'user' ? 'msg-user' : type === 'ai' ? 'msg-ai' : 'msg-error';
            let name = type === 'user' ? currentUser : PERSONALITIES[selectedPersonality].name;
            
            div.className = `flex flex-col gap-2 max-w-[85%] ${align}`;
            div.innerHTML = `
                <div class="flex items-center gap-2 mb-1 ${type === 'user' ? 'flex-row-reverse' : ''}">
                    <span class="text-[10px] font-mono uppercase text-gray-500">${name}</span>
                </div>
                <div class="${bubble} p-4 text-sm md:text-base leading-relaxed animate-fade-in">${text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>')}</div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingIndicator() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex flex-col gap-2 max-w-[80%]";
            div.innerHTML = `<div class="msg-ai p-4 w-16"><svg class="typing-dot w-2 h-2 rounded-full bg-gray-400"></svg></div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }
    </script>
</body>
</html>


