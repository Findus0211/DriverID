<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIVERID // V5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --neon-accent: #ccff00;
            --ferrari-red: #ff2800;
            --bg-dark: #050505;
            --panel-bg: #111111;
            
            --sector-green: #00ff00;
            --sector-yellow: #ffff00;
            --sector-purple: #cc00ff;
            
            /* Pirelli Colors */
            --p-soft: #ff3333;
            --p-med: #ffe600;
            --p-hard: #ffffff;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        @media (min-width: 768px) { body { overflow: hidden; } }

        h1, h2, h3, .brand-font { font-family: 'Oswald', sans-serif; text-transform: uppercase; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-accent); }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .animate-slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-fade-in { animation: fadeIn 1s ease forwards; }
        .glitch-effect { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; color: var(--ferrari-red); }
        
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0.1;
            font-size: 8rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            line-height: 1;
            pointer-events: none;
            z-index: 0;
        }
        .marquee-content { display: inline-block; animation: marquee 20s linear infinite; }

        /* Chat Bubbles */
        .msg-user { background: var(--neon-accent); color: black; border-radius: 1rem 1rem 0 1rem; }
        .msg-ai { background: var(--panel-bg); border: 1px solid #333; color: #eee; border-radius: 1rem 1rem 1rem 0; }
        .msg-error { background: rgba(255, 40, 0, 0.1); border: 1px solid var(--ferrari-red); color: #ffcccc; border-radius: 1rem 1rem 1rem 0; font-family: monospace; font-size: 0.8rem; }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; fill: #666; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .loader-bar { width: 0%; height: 2px; background: var(--neon-accent); transition: width 0.1s linear; }

        /* UI Panels */
        .glass-panel { background: rgba(17, 17, 17, 0.95); backdrop-filter: blur(10px); border: 1px solid #333; }
        .panel-border { border: 1px solid #333; }
        
        /* Engineer/Boss Select */
        .engineer-option { border: 1px solid #333; padding: 10px; cursor: pointer; transition: all 0.2s; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .engineer-option:hover { border-color: #666; background: #1a1a1a; }
        .engineer-option.selected { background: var(--neon-accent); color: black; border-color: var(--neon-accent); font-weight: bold; }
        .engineer-role { font-size: 0.6rem; opacity: 0.7; text-transform: uppercase; margin-top: 2px; letter-spacing: 0.05em; }

        /* Tyres */
        .tyre-circle { width: 40px; height: 40px; border-radius: 50%; border: 3px solid; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: 'Oswald'; font-size: 1.2rem; background: #111; }
        .tyre-soft { border-color: var(--p-soft); color: var(--p-soft); }
        .tyre-medium { border-color: var(--p-med); color: var(--p-med); }
        .tyre-hard { border-color: var(--p-hard); color: var(--p-hard); }
        
        /* Sectors (Classic) */
        .sector-box { height: 8px; flex: 1; background: #222; margin: 0 2px; transition: background 0.3s; }
        .sector-green { background: var(--sector-green); box-shadow: 0 0 5px var(--sector-green); }
        .sector-yellow { background: var(--sector-yellow); box-shadow: 0 0 5px var(--sector-yellow); }
        .sector-purple { background: var(--sector-purple); box-shadow: 0 0 5px var(--sector-purple); }

        /* Session List */
        .session-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #222; font-size: 0.75rem; }
        .session-row:last-child { border-bottom: none; }
        .session-name { color: #888; font-weight: bold; }
        .session-time { color: #fff; font-family: 'Oswald', sans-serif; }

        /* ADMIN CONSOLE */
        #admin-console { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; background: rgba(0,0,0,0.95); border-top: 2px solid var(--ferrari-red); z-index: 100; font-family: 'Courier New', monospace; font-size: 12px; color: #00ff00; padding: 10px; overflow-y: auto; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-error { color: var(--ferrari-red); }
        .log-warn { color: orange; }
        .log-success { color: var(--neon-accent); }
        
        /* HELP & ICON BUTTONS */
        .help-btn { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; border-radius: 50%; border: 1px solid #333; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; z-index: 60; }
        .help-btn:hover { border-color: var(--neon-accent); color: var(--neon-accent); }

        /* REFLEX GAME CSS */
        #reflex-game-area { cursor: crosshair; transition: background 0.1s; }
        #reflex-game-area.early { background: rgba(255, 0, 0, 0.2); }
        #reflex-game-area.go { background: rgba(204, 255, 0, 0.2); }
        .light-container { display: flex; gap: 10px; background: #000; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 2rem; }
        .light-col { display: flex; flex-direction: column; gap: 5px; }
        .light { width: 40px; height: 40px; border-radius: 50%; background: #222; transition: background 0.05s; }
        .light.on { background: #ff0000; box-shadow: 0 0 20px #ff0000; }

        /* STRATEGY BAR CSS */
        .strat-bar-container { margin-bottom: 1rem; }
        .strat-bar-label { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Oswald'; letter-spacing: 1px; }
        .strat-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .strat-bar-fill { height: 100%; border-radius: 3px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- ADMIN CONSOLE -->
    <div id="admin-console">
        <div class="text-white font-bold mb-2 sticky top-0 bg-black border-b border-gray-700 pb-1">
            FIA TECHNICAL DELEGATE // SYSTEM LOGS
            <span class="float-right cursor-pointer" onclick="document.getElementById('admin-console').style.display='none'">[CLOSE]</span>
        </div>
        <div id="log-content"></div>
    </div>

    <!-- HELP MODAL -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-md p-6 border border-[#333] relative animate-fade-in">
            <button onclick="toggleHelp()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-[#ccff00] brand-font">DRIVER BRIEFING</h2>
            <ul class="text-sm text-gray-400 space-y-2 mb-6 list-disc pl-4">
                <li><strong>Radio Check:</strong> Select a specific Race Engineer to change the AI's personality.</li>
                <li><strong>Sectors:</strong> Live tracking of car performance delta.</li>
                <li><strong>Strategy:</strong> Click [ANALYSIS] on the Tyre Widget.</li>
                <li><strong>Reflex:</strong> Click the Gamepad icon to test reactions.</li>
                <li><strong>Easter Eggs:</strong> Try callsigns like <span class="text-white">LANCE</span>, <span class="text-white">RUSSELL</span>, <span class="text-white">LANDO</span>.</li>
            </ul>
            <button onclick="toggleHelp()" class="w-full bg-white text-black font-bold py-2 uppercase hover:bg-[#ccff00] transition-colors">COPY THAT</button>
        </div>
    </div>

    <!-- REFLEX GAME MODAL -->
    <div id="reflex-modal" class="fixed inset-0 z-50 hidden flex flex-col bg-black/95 backdrop-blur-md">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <div class="flex items-center gap-2"><h2 class="text-2xl font-bold italic">REFLEX<span class="text-[#ccff00]">ID</span></h2></div>
            <button onclick="toggleReflex()" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div id="reflex-game-area" class="flex-1 flex flex-col items-center justify-center relative select-none" onclick="handleReflexInput()">
            <div class="light-container">
                <div class="light-col"><div class="light" id="l1"></div><div class="light" id="l1b"></div></div>
                <div class="light-col"><div class="light" id="l2"></div><div class="light" id="l2b"></div></div>
                <div class="light-col"><div class="light" id="l3"></div><div class="light" id="l3b"></div></div>
                <div class="light-col"><div class="light" id="l4"></div><div class="light" id="l4b"></div></div>
                <div class="light-col"><div class="light" id="l5"></div><div class="light" id="l5b"></div></div>
            </div>
            <div class="text-center pointer-events-none z-20">
                <h1 id="reflex-status" class="text-6xl md:text-8xl font-bold italic mb-2 font-mono">START</h1>
                <p id="reflex-sub" class="text-gray-400 uppercase tracking-widest">Tap anywhere to begin</p>
            </div>
            <div class="absolute bottom-10 flex gap-8 text-center">
                <div><p class="text-[10px] text-gray-500">LAST TIME</p><p class="text-2xl font-mono" id="last-time">--.---</p></div>
                <div><p class="text-[10px] text-gray-500">SESSION BEST</p><p class="text-2xl font-mono text-[#ccff00]" id="best-time">--.---</p></div>
            </div>
        </div>
    </div>

    <!-- STRATEGY MODAL -->
    <div id="strategy-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-md p-6 border border-[#333] relative animate-fade-in">
            <button onclick="toggleStrategy()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-1 text-[#ccff00] brand-font">PIRELLI STRATEGY</h2>
            <p class="text-xs text-gray-400 mb-6 font-mono" id="strat-track-name">TRACK ANALYSIS</p>
            <div class="flex gap-4 mb-6 border-b border-gray-800 pb-4">
                <div class="flex-1 text-center border-r border-gray-800">
                    <p class="text-[10px] text-gray-500 mb-1">COMPOUNDS</p><p class="text-xl font-bold" id="strat-compounds">C1-C2-C3</p>
                </div>
                <div class="flex-1 text-center">
                    <p class="text-[10px] text-gray-500 mb-1">PIT LOSS</p><p class="text-xl font-bold text-white" id="strat-pitloss">22.5s</p>
                </div>
            </div>
            <div id="tyre-life-container"></div>
            <div class="mt-4 text-[10px] text-gray-600 text-center">*ESTIMATED LIFE BASED ON FUEL LOAD & TRACK TEMP</div>
        </div>
    </div>

    <!-- Background Marquee -->
    <div class="marquee-container">
        <div class="marquee-content">
            2025 SEASON // LIGHTS OUT AND AWAY WE GO // DRS ENABLED // BOX BOX BOX // 
            2025 SEASON // LIGHTS OUT AND AWAY WE GO // DRS ENABLED // BOX BOX BOX //
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-transform duration-700 overflow-y-auto">
        <button class="help-btn" onclick="toggleHelp()">?</button>
        <div class="w-full max-w-lg p-6 md:p-8 relative z-10 animate-slide-up my-auto">
            <div class="mb-6 text-center">
                <h1 class="text-6xl font-bold tracking-tighter mb-2 italic">DRIVER<span class="text-[#ccff00]">ID</span></h1>
                <p class="text-gray-400 tracking-widest text-xs uppercase">Telemetry System V5.2</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div class="relative group">
                    <input type="text" id="username-input" required class="w-full bg-transparent border-b-2 border-gray-700 text-3xl font-bold text-white py-2 focus:outline-none focus:border-[#ccff00] transition-colors uppercase placeholder-gray-800" placeholder="ENTER CALLSIGN">
                    <div class="absolute right-0 top-4 text-[#ccff00] opacity-0 group-focus-within:opacity-100 transition-opacity"><i data-lucide="terminal"></i></div>
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-3 uppercase tracking-wider">Select Radio Channel</label>
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-2" id="engineer-grid"></div>
                </div>
                <button type="submit" class="w-full bg-[#ccff00] text-black font-bold py-4 px-8 text-xl hover:bg-white transition-colors duration-300 uppercase tracking-wider flex items-center justify-center gap-2 mt-4"><span>Initialize Session</span><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
            </form>
            <div id="loading-bar-container" class="mt-8 hidden">
                <p class="text-xs text-[#ccff00] mb-1 font-mono">ESTABLISHING SECURE UPLINK...</p>
                <div class="w-full bg-gray-900 h-1"><div id="progress-bar" class="loader-bar"></div></div>
            </div>
            <div class="mt-6 text-[10px] text-gray-600 font-mono text-center leading-tight">
                WARNING: UNAUTHORIZED INTERCEPTION OF TEAM RADIO IS A FEDERAL OFFENSE.<br>
                SECURE CONNECTION: TLS 1.3 ENCRYPTED.
                <br><br>
                <span class="opacity-50">NOT OFFICIALLY AFFILIATED WITH FORMULA 1, FIA OR ANY TEAMS. FAN PROJECT ONLY.</span>
            </div>
        </div>
    </div>

    <!-- Meme Overlay -->
    <div id="meme-overlay" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center p-4 text-center pointer-events-none bg-black/95">
        <h2 id="meme-title" class="text-4xl md:text-6xl font-bold text-[#ccff00] mb-4 brand-font italic tracking-tighter"></h2>
        <img id="meme-img" src="" class="meme-image object-contain mb-4 rounded-lg hidden max-h-[50vh] border-2 border-[#ccff00] shadow-[0_0_30px_#ccff00]">
        <p id="meme-text" class="text-xl md:text-2xl text-white font-mono bg-black px-4 py-2"></p>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-lg p-6 border border-[#333] relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-[#ccff00]">CONFIG</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-2 uppercase">Admin Override Code</label>
                    <input type="password" id="admin-code-input" class="w-full bg-black border border-gray-700 p-3 text-white font-mono text-sm focus:border-[#ccff00] focus:outline-none" placeholder="ENTER CODE TO VIEW LOGS" oninput="checkAdminCode(this)">
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-2 uppercase">Active Model ID</label>
                    <input type="text" id="model-input" class="w-full bg-black border border-gray-700 p-3 text-gray-500 font-mono text-xs" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="flex-1 flex flex-col md:flex-row overflow-y-auto md:overflow-hidden h-full">
        <header class="flex justify-between items-center p-4 border-b border-gray-800 bg-black/50 backdrop-blur-md h-16 flex-shrink-0 sticky top-0 z-20 md:static w-full">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-[#ccff00] flex items-center justify-center rounded-full text-black font-bold text-lg" id="avatar-initial">D</div>
                <div>
                    <h2 class="text-lg leading-none" id="display-name">DRIVER</h2>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-[10px] text-gray-400 font-mono tracking-wider" id="engineer-display">LINK: SEARCHING...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="toggleReflex()" class="text-gray-500 hover:text-[#ccff00]" title="Reflex Trainer"><i data-lucide="gamepad-2" class="w-5 h-5"></i></button>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-[#ccff00]" title="Settings"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="logout()" class="text-gray-500 hover:text-white" title="Logout"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="flex flex-col min-h-[75vh] md:h-full md:flex-1 relative z-10">
            <main class="flex-1 overflow-y-auto p-4 space-y-6" id="chat-container"></main>
            <div class="p-4 bg-black/80 border-t border-gray-800 backdrop-blur-md">
                <form id="chat-form" class="relative w-full flex items-end gap-2">
                    <div class="flex-1 bg-[#111] border border-gray-700 rounded-lg focus-within:border-[#ccff00] transition-colors relative">
                        <textarea id="user-input" rows="1" class="w-full bg-transparent text-white p-3 pr-10 focus:outline-none resize-none max-h-32 text-sm" placeholder="Radio message..." oninput="autoResize(this)"></textarea>
                    </div>
                    <button type="submit" class="h-[46px] w-[46px] bg-white text-black hover:bg-[#ccff00] flex items-center justify-center rounded-lg transition-colors"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>

        <div class="flex flex-col w-full md:w-80 border-t md:border-t-0 md:border-l border-gray-800 bg-[#0a0a0a] p-4 gap-4 shrink-0 md:h-full md:overflow-y-auto">
            <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2"><i data-lucide="flag" class="w-3 h-3"></i> NEXT GRAND PRIX</h3>
                <div id="next-race-container">
                    <h2 class="text-xl font-bold text-[#ccff00] leading-tight mb-1" id="race-name">LOADING...</h2>
                    <p class="text-sm text-white mb-3" id="race-circuit">...</p>
                    <div class="bg-black p-2 font-mono text-center text-red-500 border border-red-900/30 mb-4" id="countdown-timer">T-MINUS 00:00:00:00</div>
                    <div id="session-list" class="space-y-1"></div>
                </div>
            </div>
            <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2"><i data-lucide="cloud-rain" class="w-3 h-3"></i> METEOROLOGY <span id="weather-location" class="ml-auto text-[8px] text-gray-600">UPLINK</span></h3>
                <div class="flex justify-between items-center mb-2">
                    <div class="text-center"><span class="block text-2xl font-bold" id="air-temp">--째</span><span class="text-[10px] text-gray-400">AIR</span></div>
                    <div class="text-center"><span class="block text-2xl font-bold text-orange-400" id="track-temp">--째</span><span class="text-[10px] text-gray-400">TRACK</span></div>
                    <div class="text-center"><span class="block text-2xl font-bold text-blue-400" id="rain-prob">0%</span><span class="text-[10px] text-gray-400">RAIN</span></div>
                </div>
                <div class="w-full bg-gray-800 h-1 mt-1"><div class="bg-blue-500 h-1" id="rain-bar" style="width: 0%"></div></div>
            </div>
            <div class="panel-border p-4 bg-[#111]">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs text-gray-500 font-mono flex items-center gap-2"><i data-lucide="disc" class="w-3 h-3"></i> TYRE STATUS</h3>
                    <button onclick="toggleStrategy()" class="text-[10px] text-[#ccff00] font-mono border border-[#ccff00] px-1 hover:bg-[#ccff00] hover:text-black transition-colors">[ANALYSIS]</button>
                </div>
                <div class="flex justify-around mb-3">
                    <div class="text-center opacity-50 hover:opacity-100 transition-opacity cursor-pointer"><div class="tyre-circle tyre-soft mx-auto mb-1">S</div><span class="text-[10px]">USED</span></div>
                    <div class="text-center"><div class="tyre-circle tyre-medium mx-auto mb-1 ring-2 ring-white">M</div><span class="text-[10px] text-[#ccff00]">ACTIVE</span></div>
                    <div class="text-center opacity-50 hover:opacity-100 transition-opacity cursor-pointer"><div class="tyre-circle tyre-hard mx-auto mb-1">H</div><span class="text-[10px]">NEW</span></div>
                </div>
                <div class="flex justify-between text-[10px] font-mono text-gray-400 mb-1"><span>WEAR</span><span class="text-white">12%</span></div>
                <div class="w-full bg-gray-800 h-1"><div class="bg-green-500 h-1" style="width: 88%"></div></div>
            </div>
             <div class="panel-border p-4 bg-[#111]">
                <h3 class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-2"><i data-lucide="map" class="w-3 h-3"></i> SECTORS</h3>
                <div class="flex w-full mb-1"><div class="sector-box sector-green" id="s1"></div><div class="sector-box sector-yellow" id="s2"></div><div class="sector-box sector-green" id="s3"></div></div>
                <div class="flex justify-between text-[10px] font-mono text-gray-500"><span>S1</span><span>S2</span><span>S3</span></div>
            </div>
            <div class="h-8 md:hidden"></div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyBvbk52dZnOeKsMpnJUoL7TjjlHNYCLWMg";
        
        // --- TYRE DATA & LOGIC ---
        const TRACK_DATA = {
            "QATAR": { deg: "HIGH", pitLoss: "24.5s", compounds: "C1-C2-C3", life: { soft: "12-15 Laps", med: "20-25 Laps", hard: "35-40 Laps" } },
            "ABU DHABI": { deg: "MEDIUM", pitLoss: "22.0s", compounds: "C3-C4-C5", life: { soft: "15-18 Laps", med: "25-30 Laps", hard: "40+ Laps" } },
            "BAHRAIN": { deg: "HIGH", pitLoss: "23.5s", compounds: "C1-C2-C3", life: { soft: "12-14 Laps", med: "18-22 Laps", hard: "35+ Laps" } },
            "SAUDI": { deg: "LOW", pitLoss: "20.0s", compounds: "C2-C3-C4", life: { soft: "18-22 Laps", med: "30-35 Laps", hard: "50 Laps" } },
            "AUSTRALIA": { deg: "MEDIUM", pitLoss: "21.0s", compounds: "C3-C4-C5", life: { soft: "15-20 Laps", med: "28-35 Laps", hard: "45+ Laps" } },
            "MONACO": { deg: "LOW", pitLoss: "19.0s", compounds: "C3-C4-C5", life: { soft: "30+ Laps", med: "45+ Laps", hard: "60+ Laps" } },
            "DEFAULT": { deg: "MEDIUM", pitLoss: "22.5s", compounds: "C2-C3-C4", life: { soft: "15-20 Laps", med: "25-30 Laps", hard: "40+ Laps" } }
        };

        // --- REFLEX GAME LOGIC ---
        let reflexState = "IDLE", reflexStartTime = 0, reflexTimeouts = [], reflexBest = null;
        const reflexLights = [['l1','l1b'],['l2','l2b'],['l3','l3b'],['l4','l4b'],['l5','l5b']];

        function toggleReflex() {
            const modal = document.getElementById('reflex-modal');
            if(modal.classList.contains('hidden')) { modal.classList.remove('hidden'); resetReflex(); } 
            else { modal.classList.add('hidden'); }
        }
        function toggleStrategy() {
            const modal = document.getElementById('strategy-modal');
            modal.classList.toggle('hidden');
            updateStrategyModal();
        }
        function toggleHelp() { document.getElementById('help-modal').classList.toggle('hidden'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }

        function updateStrategyModal() {
            let raceKey = "DEFAULT";
            if(currentRaceData) {
                for(const key in TRACK_DATA) {
                    if(currentRaceData.name.toUpperCase().includes(key)) {
                        raceKey = key;
                        break;
                    }
                }
            }
            const data = TRACK_DATA[raceKey];
            document.getElementById('strat-track-name').innerText = currentRaceData ? currentRaceData.name : "UNKNOWN CIRCUIT";
            document.getElementById('strat-compounds').innerText = data.compounds;
            document.getElementById('strat-pitloss').innerText = data.pitLoss;
            const container = document.getElementById('tyre-life-container');
            container.innerHTML = `
                <div class="strat-bar-container"><div class="strat-bar-label"><span class="text-[#ff3333]">SOFT (C${data.compounds.split('-')[2].replace('C','')})</span><span>${data.life.soft}</span></div><div class="strat-bar-bg"><div class="strat-bar-fill bg-[#ff3333]" style="width: 30%"></div></div></div>
                <div class="strat-bar-container"><div class="strat-bar-label"><span class="text-[#ffe600]">MEDIUM (C${data.compounds.split('-')[1].replace('C','')})</span><span>${data.life.med}</span></div><div class="strat-bar-bg"><div class="strat-bar-fill bg-[#ffe600]" style="width: 60%"></div></div></div>
                <div class="strat-bar-container"><div class="strat-bar-label"><span class="text-white">HARD (C${data.compounds.split('-')[0].replace('C','')})</span><span>${data.life.hard}</span></div><div class="strat-bar-bg"><div class="strat-bar-fill bg-white" style="width: 90%"></div></div></div>
            `;
        }

        function handleReflexInput() {
            if (reflexState === "IDLE" || reflexState === "FINISHED" || reflexState === "EARLY") startReflexSequence();
            else if (reflexState === "WAITING") triggerReflexJumpstart();
            else if (reflexState === "READY") finishReflex();
        }

        function startReflexSequence() {
            resetReflexLights();
            reflexState = "WAITING";
            document.getElementById('reflex-status').innerText = "READY";
            document.getElementById('reflex-status').className = "text-6xl md:text-8xl font-bold italic mb-2 font-mono text-white";
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                reflexTimeouts.push(setTimeout(() => {
                    if (reflexState !== "WAITING") return;
                    document.getElementById(reflexLights[i][0]).classList.add('on');
                    document.getElementById(reflexLights[i][1]).classList.add('on');
                }, delay));
                delay += 1000;
            }
            const randomDelay = delay + Math.random() * 3000 + 500;
            reflexTimeouts.push(setTimeout(() => { if (reflexState !== "WAITING") return; goReflex(); }, randomDelay));
        }

        function goReflex() {
            reflexState = "READY";
            reflexStartTime = Date.now();
            reflexLights.flat().forEach(id => document.getElementById(id).classList.remove('on'));
            document.getElementById('reflex-status').innerText = "GO!";
            document.getElementById('reflex-status').className = "text-6xl md:text-8xl font-bold italic mb-2 font-mono text-[#ccff00]";
        }

        function finishReflex() {
            const reaction = (Date.now() - reflexStartTime) / 1000;
            reflexState = "FINISHED";
            document.getElementById('reflex-status').innerText = reaction.toFixed(3) + "s";
            document.getElementById('reflex-status').className = "text-6xl md:text-8xl font-bold italic mb-2 font-mono text-white";
            if (!reflexBest || reaction < reflexBest) {
                reflexBest = reaction;
                document.getElementById('best-time').innerText = reaction.toFixed(3) + "s";
            }
        }

        function triggerReflexJumpstart() {
            reflexState = "EARLY";
            reflexTimeouts.forEach(clearTimeout);
            resetReflexLights();
            document.getElementById('reflex-status').innerText = "JUMP START";
            document.getElementById('reflex-status').className = "text-6xl md:text-8xl font-bold italic mb-2 font-mono text-[#ff2800]";
        }

        function resetReflexLights() { reflexLights.flat().forEach(id => document.getElementById(id).classList.remove('on')); }
        function resetReflex() { reflexState = "IDLE"; reflexTimeouts.forEach(clearTimeout); document.getElementById('reflex-status').innerText = "START"; resetReflexLights(); }

        const PERSONALITIES = {
            "GP": { name: "GP", role: "Race Engineer", team: "REDBULL", prompt: "You are GP. Blunt, stoic.", welcome: "Radio check. Head down." },
            "CHRISTIAN": { name: "CHRISTIAN", role: "Team Principal", team: "REDBULL", prompt: "You are Christian Horner. Stirring pot.", welcome: "Let's go racing." },
            "BONO": { name: "BONO", role: "Race Engineer", team: "MERCEDES", prompt: "You are Bono. Encouraging. 'Hammer Time'.", welcome: "Radio check Lewis." },
            "TOTO": { name: "TOTO", role: "Team Principal", team: "MERCEDES", prompt: "You are Toto. 'No Mikey No'.", welcome: "I sent an email." },
            "FRED": { name: "FRED", role: "Team Principal", team: "FERRARI", prompt: "You are Fred Vasseur. Jolly but serious.", welcome: "We are checking." },
            "XAVI": { name: "XAVI", role: "Legacy Engineer", team: "FERRARI", prompt: "You are Xavi. Indecisive.", welcome: "We are checking..." },
            "WILL": { name: "WILL", role: "Race Engineer", team: "MCLAREN", prompt: "You are Will Joseph. Fast talking.", welcome: "Gap behind 1.5." },
            "ZAK": { name: "ZAK", role: "CEO", team: "MCLAREN", prompt: "You are Zak Brown. Marketing speak.", welcome: "Papaya rules!" },
            "GUENTHER": { name: "GUENTHER", role: "Legend", team: "HAAS", prompt: "You are Guenther. Profane.", welcome: "Hygiene." },
            "STANDARD": { name: "PIT WALL", role: "Standard", team: "NEUTRAL", prompt: "Professional F1 Engineer.", welcome: "Radio check." }
        };

        const MEME_DB = {
            "MAX": { title: "DUDUDUDU", url: "https://media.tenor.com/N6uXoR6wW2AAAAAM/max-verstappen-haha-yes.gif", text: "SIMPLY LOVELY" },
            "CHECO": { title: "MINISTER OF DEFENCE", url: "https://media.tenor.com/2Xy-j-4gW2cAAAAM/checo-perez-sergio-perez.gif", text: "INTIMIDATING" },
            "LEWIS": { title: "FERRARI RED", url: "https://media.tenor.com/T_y_tJ5_K9AAAAAM/lewis-hamilton-mercedes.gif", text: "BONO MY TIRES" },
            "HAMILTON": { title: "BLESSED", url: "https://media.tenor.com/T_y_tJ5_K9AAAAAM/lewis-hamilton-mercedes.gif", text: "GET IN THERE" },
            "CHARLES": { title: "PAIN", url: "https://media.tenor.com/W3tY2Qc_xJAAAAAM/charles-leclerc-scream.gif", text: "NOOOOOOOOO!" },
            "LECLERC": { title: "I AM STUPID", url: "https://media.tenor.com/J4p7l_tQhBwAAAAM/leclerc-charles-leclerc.gif", text: "WE ARE CHECKING" },
            "GEORGE": { title: "THE POSE", url: "https://media.tenor.com/60kKq_Zz7CgAAAAM/george-russell-pose.gif", text: "FACTS." },
            "RUSSELL": { title: "OSAMA BIN RUSSELL", url: "https://media.tenor.com/60kKq_Zz7CgAAAAM/george-russell-pose.gif", text: "I WAS FORECAST A PODIUM" },
            "KIMI": { title: "THE PRODIGY", url: "https://media.tenor.com/K_yQ1xXzJzAAAAAM/kimi-raikkonen-drink.gif", text: "NOT THAT KIMI" },
            "ANTONELLI": { title: "ROOKIE 1", url: "https://media.tenor.com/K_yQ1xXzJzAAAAAM/kimi-raikkonen-drink.gif", text: "SKIP F3?" },
            "LANDO": { title: "FRIDAY THEN", url: "https://media.tenor.com/P_C9uOQ4s5oAAAAM/lando-norris-dancing.gif", text: "SATURDAY SUNDAY WHAT?" },
            "NORRIS": { title: "BROKEN TROPHY", url: "https://media.tenor.com/ZzK8yXbVljoAAAAM/lando-norris-champagne.gif", text: "OOPS." },
            "OSCAR": { title: "WEBBER 2.0", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oscar-piastri.gif", text: "CALM." },
            "PIASTRI": { title: "OSCAR P1ASTRI", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oscar-piastri.gif", text: "NO DRAMA MATE" },
            "ALONSO": { title: "EL PLAN", url: "https://media.tenor.com/5h8w7r_tqAAAAAAM/fernando-alonso-alpina.gif", text: "QUE GRANDE ERES" },
            "FERNANDO": { title: "ROOKIE OF THE YEAR", url: "https://media.tenor.com/5h8w7r_tqAAAAAAM/fernando-alonso-alpina.gif", text: "FOREVER YOUNG" },
            "LANCE": { title: "THE CRASHER", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/lance-stroll.gif", text: "I HIT THE WALL" },
            "STROLL": { title: "DADDYS MONEY", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/lance-stroll.gif", text: "INTERGALACTIC" },
            "PIERRE": { title: "LIKED BY PIERRE GASLY", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/pierre-gasly.gif", text: "INSTAGRAM KING" },
            "GASLY": { title: "TRIPOD", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/pierre-gasly.gif", text: "ESTEBAN WHO?" },
            "JACK": { title: "DOOOOOOHAN", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alpine-f1.gif", text: "THE SURVIVOR" },
            "DOOHAN": { title: "ROOKIE 2", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alpine-f1.gif", text: "FINALLY GOT THE SEAT" },
            "CARLOS": { title: "SMOOTH OPERATOR", url: "https://media.tenor.com/SPrBwz2gB9AAAAAM/carlos-sainz-smooth-operator.gif", text: "SMOOOOOOOTH" },
            "SAINZ": { title: "STOP INVENTING", url: "https://media.tenor.com/0vK3q8tXwWAAAAAM/carlos-sainz-ferrari.gif", text: "WILLIAMS ERA" },
            "ALEX": { title: "ALBONO", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alex-albon.gif", text: "THE PET WHISPERER" },
            "ALBON": { title: "RED HAIR", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/alex-albon.gif", text: "NO MORE APPENDIX" },
            "OCON": { title: "5 SECOND PENALTY", url: "https://media.tenor.com/Q_y_tJ5_K9AAAAAM/esteban-ocon.gif", text: "FOR OCON" },
            "ESTIE BESTIE": { title: "TEAM MATE WAR", url: "https://media.tenor.com/Q_y_tJ5_K9AAAAAM/esteban-ocon.gif", text: "DEFEND LIKE A LION" },
            "OLLIE": { title: "SAUDI SUB", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oliver-bearman.gif", text: "POINTS ON DEBUT" },
            "BEARMAN": { title: "ROOKIE 3", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/oliver-bearman.gif", text: "UNCLE AYAO" },
            "YUKI": { title: "RADIO RAGE", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/yuki-tsunoda.gif", text: "OPEN THE DOOR" },
            "TSUNODA": { title: "CHEF YUKI", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/yuki-tsunoda.gif", text: "TINY BUT MIGHTY" },
            "LIAM": { title: "SUPER SUB", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/liam-lawson.gif", text: "THE KIWI IS BACK" },
            "LAWSON": { title: "NO RICCIARDO", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/liam-lawson.gif", text: "IT'S MY SEAT" },
            "HULK": { title: "HULKENBACK", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/nico-hulkenberg.gif", text: "PODIUM MAYBE?" },
            "NICO": { title: "THE VETERAN", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/nico-hulkenberg.gif", text: "AUDI WAITING ROOM" },
            "GABRIEL": { title: "ROOKIE 4", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/f2-champion.gif", text: "BRASIL IS BACK" },
            "BORTOLETO": { title: "THE NEW SENNA?", url: "https://media.tenor.com/P0g3y6wW2AAAAAAM/f2-champion.gif", text: "NO PRESSURE KID" }
        };

        const RACE_CALENDAR = [
            { name: "QATAR GRAND PRIX", circuit: "LUSAIL INT. CIRCUIT", date: new Date("2025-11-30T17:00:00"), lat: 25.4888, long: 51.4542, sessions: [{ name: "FP1", time: "FRI 13:30" }, { name: "SPRINT Q", time: "FRI 17:30" }, { name: "SPRINT", time: "SAT 13:00" }, { name: "QUALI", time: "SAT 17:00" }, { name: "RACE", time: "SUN 17:00" }] }, 
            { name: "ABU DHABI GP", circuit: "YAS MARINA CIRCUIT", date: new Date("2025-12-07T14:00:00"), lat: 24.4672, long: 54.6031, sessions: [{ name: "FP1", time: "FRI 09:30" }, { name: "FP2", time: "FRI 13:00" }, { name: "FP3", time: "SAT 10:30" }, { name: "QUALI", time: "SAT 14:00" }, { name: "RACE", time: "SUN 13:00" }] },
            { name: "BAHRAIN GP", circuit: "SAKHIR", date: new Date("2026-03-01T15:00:00"), lat: 26.0325, long: 50.5106, sessions: [{name: "RACE", time: "SUN 15:00"}] },
            { name: "SAUDI ARABIAN GP", circuit: "JEDDAH CORNICHE", date: new Date("2026-03-08T17:00:00"), lat: 21.6319, long: 39.1044, sessions: [{name: "RACE", time: "SUN 17:00"}] },
            { name: "AUSTRALIAN GP", circuit: "ALBERT PARK", date: new Date("2026-03-22T05:00:00"), lat: -37.8497, long: 144.968, sessions: [{name: "RACE", time: "SUN 05:00"}] },
            { name: "JAPANESE GP", circuit: "SUZUKA", date: new Date("2026-04-05T06:00:00"), lat: 34.8431, long: 136.541, sessions: [{name: "RACE", time: "SUN 06:00"}] },
            { name: "CHINESE GP", circuit: "SHANGHAI", date: new Date("2026-04-19T08:00:00"), lat: 31.3389, long: 121.220, sessions: [{name: "RACE", time: "SUN 08:00"}] },
            { name: "MIAMI GP", circuit: "MIAMI INT. AUTODROME", date: new Date("2026-05-03T20:30:00"), lat: 25.9580, long: -80.2389, sessions: [{name: "RACE", time: "SUN 20:30"}] },
            { name: "EMILIA ROMAGNA GP", circuit: "IMOLA", date: new Date("2026-05-17T14:00:00"), lat: 44.3439, long: 11.7167, sessions: [{name: "RACE", time: "SUN 14:00"}] },
            { name: "MONACO GP", circuit: "MONTE CARLO", date: new Date("2026-05-24T14:00:00"), lat: 43.7347, long: 7.4205, sessions: [{name: "RACE", time: "SUN 14:00"}] }
        ];

        let currentUser = null;
        let selectedPersonality = "STANDARD";
        let chatHistory = [];
        let currentRaceData = null;
        
        const MODEL_CASCADE = [
            "gemini-3-pro-preview",
            "gemini-flash-latest",
            "gemini-flash-lite-latest",
            "gemini-2.5-flash-preview-09-2025"
        ];
        let currentModel = "SEARCHING"; 

        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const dashboard = document.getElementById('dashboard');
        const usernameInput = document.getElementById('username-input');
        const displayName = document.getElementById('display-name');
        const avatarInitial = document.getElementById('avatar-initial');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const loadingContainer = document.getElementById('loading-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const settingsModal = document.getElementById('settings-modal');
        const engineerDisplay = document.getElementById('engineer-display');
        const memeOverlay = document.getElementById('meme-overlay');
        const engineerGrid = document.getElementById('engineer-grid');
        const raceNameEl = document.getElementById('race-name');
        const raceCircuitEl = document.getElementById('race-circuit');
        const countdownEl = document.getElementById('countdown-timer');
        const sessionListEl = document.getElementById('session-list');
        const s1 = document.getElementById('s1');
        const s2 = document.getElementById('s2');
        const s3 = document.getElementById('s3');
        const adminConsole = document.getElementById('admin-console');
        const logContent = document.getElementById('log-content');
        const helpModal = document.getElementById('help-modal');
        
        // Weather DOM
        const weatherLocEl = document.getElementById('weather-location');
        const airTempEl = document.getElementById('air-temp');
        const trackTempEl = document.getElementById('track-temp');
        const rainProbEl = document.getElementById('rain-prob');
        const rainBarEl = document.getElementById('rain-bar');

        // --- INIT ---
        window.addEventListener('load', () => {
            if(window.lucide) lucide.createIcons();
            renderPersonalitySelect();
            initRaceControl();
            startTelemetrySimulation();
        });
        checkSession();

        function toggleSettings() { settingsModal.classList.toggle('hidden'); }
        function toggleHelp() { helpModal.classList.toggle('hidden'); }
        
        function renderPersonalitySelect() {
            engineerGrid.innerHTML = '';
            for (const key in PERSONALITIES) {
                const p = PERSONALITIES[key];
                const div = document.createElement('div');
                div.className = `engineer-option ${key === selectedPersonality ? 'selected' : 'text-gray-400'}`;
                div.innerHTML = `<span class="font-bold text-sm">${p.name}</span><span class="engineer-role">${p.role}</span>`;
                div.onclick = () => { selectedPersonality = key; renderPersonalitySelect(); };
                engineerGrid.appendChild(div);
            }
        }

        function checkAdminCode(input) {
            if (input.value === "0211") {
                adminConsole.style.display = 'block';
                toggleSettings();
                logMessage("ADMIN ACCESS GRANTED. DEBUG MODE ACTIVE.", "success");
                input.value = "";
            }
        }

        function logMessage(msg, type = "info") {
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerText = `[${new Date().toISOString().split('T')[1].split('.')[0]}] ${msg}`;
            logContent.appendChild(div);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // --- RACE CONTROL LOGIC ---
        function initRaceControl() {
            const now = new Date();
            let nextRace = RACE_CALENDAR.find(r => r.date > now);
            if (!nextRace) nextRace = RACE_CALENDAR[0];
            currentRaceData = nextRace;

            raceNameEl.innerText = nextRace.name;
            raceCircuitEl.innerText = nextRace.circuit;
            weatherLocEl.innerText = `LIVE FEED: ${nextRace.circuit.split(' ')[0].toUpperCase()}`;
            
            sessionListEl.innerHTML = '';
            if (nextRace.sessions) {
                nextRace.sessions.forEach(session => {
                    const div = document.createElement('div');
                    div.className = 'session-row';
                    div.innerHTML = `<span class="session-name">${session.name}</span><span class="session-time">${session.time}</span>`;
                    sessionListEl.appendChild(div);
                });
            }

            setInterval(() => {
                const currentTime = new Date();
                const diff = nextRace.date - currentTime;
                if (diff > 0) {
                   const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                   const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                   const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                   const s = Math.floor((diff % (1000 * 60)) / 1000);
                   countdownEl.innerText = `T-MINUS ${d}d ${h}h ${m}m ${s}s`;
                } else {
                    countdownEl.innerText = "SESSION ACTIVE";
                    countdownEl.className = "bg-black p-2 font-mono text-center text-[#ccff00] border border-[#ccff00]/30 mb-4 animate-pulse";
                }
            }, 1000);
            fetchRealWeather();
            setInterval(fetchRealWeather, 300000);
        }

        // --- REAL WEATHER ENGINE (OPEN-METEO) ---
        async function fetchRealWeather() {
            if (!currentRaceData || !currentRaceData.lat) return;
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentRaceData.lat}&longitude=${currentRaceData.long}&current_weather=true`);
                const data = await response.json();
                if (data.current_weather) {
                    const temp = data.current_weather.temperature;
                    const isNight = currentRaceData.name.includes("QATAR") || currentRaceData.name.includes("SAUDI");
                    const trackOffset = isNight ? 5 : 12;
                    airTempEl.innerText = `${temp.toFixed(1)}째C`;
                    trackTempEl.innerText = `${(temp + trackOffset).toFixed(1)}째C`;
                    const code = data.current_weather.weathercode;
                    let rainChance = 0;
                    if (code > 50) rainChance = 60;
                    if (code > 80) rainChance = 90;
                    rainProbEl.innerText = `${rainChance}%`;
                    rainBarEl.style.width = `${rainChance}%`;
                    if (rainChance > 50) rainProbEl.classList.add('text-blue-400'); else rainProbEl.classList.remove('text-blue-400');
                }
            } catch (e) { console.warn("Weather API failed."); }
        }

        function startTelemetrySimulation() {
            setInterval(() => {
                const r = Math.random();
                if(r > 0.9) s1.className = "sector-box sector-yellow";
                else if(r > 0.6) s1.className = "sector-box sector-purple";
                else s1.className = "sector-box sector-green";
            }, 4000);
             setInterval(() => {
                const r = Math.random();
                if(r > 0.95) s2.className = "sector-box sector-yellow";
                else s2.className = "sector-box sector-green";
            }, 5000);
             setInterval(() => {
                const r = Math.random();
                if(r > 0.8) s3.className = "sector-box sector-purple";
                else s3.className = "sector-box sector-green";
            }, 3000);
        }

        function identifyDriverTeam(name) {
            const n = name.toUpperCase();
            if (n.includes("MAX") || n.includes("CHECO")) return "REDBULL";
            if (n.includes("LEWIS") || n.includes("CHARLES")) return "FERRARI";
            if (n.includes("GEORGE") || n.includes("KIMI") || n.includes("ANTONELLI")) return "MERCEDES";
            if (n.includes("LANDO") || n.includes("OSCAR")) return "MCLAREN";
            if (n.includes("ALONSO") || n.includes("LANCE") || n.includes("STROLL")) return "ASTON";
            return "UNKNOWN";
        }

        function getRelationshipContext(driver, personalityKey) {
            const driverTeam = identifyDriverTeam(driver);
            const p = PERSONALITIES[personalityKey];
            if (driver.toUpperCase().includes("LEWIS") && personalityKey === "BONO") return "The user is Lewis Hamilton. You are Bono. Lewis has left for Ferrari. You are still at Mercedes. Act nostalgic or sad.";
            if (driver.toUpperCase().includes("MAX") && personalityKey === "TOTO") return "The user is Max Verstappen. You are Toto. You are rivals. Be hostile.";
            if (driverTeam === p.team) return `The user drives for your team (${p.team}). Be supportive.`;
            else if (driverTeam !== "UNKNOWN" && p.team !== "NEUTRAL") return `The user drives for a RIVAL team (${driverTeam}). Be suspicious.`;
            return "The user is an unknown driver. Treat with caution.";
        }

        function checkSession() {
            const storedUser = localStorage.getItem('race_engineer_user');
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                selectedPersonality = userData.engineer || "STANDARD";
                renderPersonalitySelect();
                login(userData.username, false);
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (!username) return;
            const upperUser = username.toUpperCase();
            let meme = MEME_DB[upperUser];
            if (!meme) { for (const key in MEME_DB) { if (upperUser.includes(key)) { meme = MEME_DB[key]; break; } } }
            if (meme) { triggerMeme(meme, username); } else { startLoginProcess(username); }
        });

        function triggerMeme(meme, username) {
            loginForm.classList.add('opacity-0');
            memeOverlay.classList.remove('hidden');
            memeOverlay.classList.remove('pointer-events-none');
            document.getElementById('meme-title').innerText = meme.title;
            document.getElementById('meme-text').innerText = meme.text;
            document.getElementById('meme-img').src = meme.url;
            document.getElementById('meme-img').classList.remove('hidden');
            document.getElementById('meme-title').classList.add('glitch-effect');
            setTimeout(() => {
                memeOverlay.classList.add('hidden');
                document.getElementById('meme-title').classList.remove('glitch-effect');
                startLoginProcess(username);
            }, 3500);
        }

        function startLoginProcess(username) {
            loginForm.classList.remove('opacity-0');
            loginForm.querySelector('button').classList.add('hidden');
            loadingContainer.classList.remove('hidden');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    localStorage.setItem('race_engineer_user', JSON.stringify({ username, engineer: selectedPersonality }));
                    login(username, true);
                } else { width += Math.random() * 20; progressBar.style.width = width + '%'; }
            }, 150);
        }

        function login(username, animate) {
            currentUser = username;
            displayName.innerText = username;
            avatarInitial.innerText = username.charAt(0).toUpperCase();
            const p = PERSONALITIES[selectedPersonality];
            engineerDisplay.innerText = `RADIO: ${p.name}`;
            if (chatContainer.children.length === 0) addMessage(p.welcome, 'ai');
            if (animate) {
                setTimeout(() => {
                    loginOverlay.style.transform = 'translateY(-100%)';
                    dashboard.classList.remove('pointer-events-none', 'opacity-0');
                    if(window.lucide) lucide.createIcons();
                }, 500);
            } else {
                loginOverlay.style.display = 'none';
                dashboard.classList.remove('pointer-events-none', 'opacity-0');
                if(window.lucide) lucide.createIcons();
            }
        }

        function logout() { localStorage.removeItem('race_engineer_user'); location.reload(); }
        function autoResize(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }

        async function fetchWithFallback(text, attempt = 0) {
            if (attempt >= MODEL_CASCADE.length) {
                logMessage("ALL MODELS FAILED.", "error");
                throw new Error("Link failure.");
            }
            const modelToTry = MODEL_CASCADE[attempt];
            document.getElementById('engineer-display').innerText = `LINKING: ${modelToTry.split('-')[1].toUpperCase()}...`;
            logMessage(`Connecting to ${modelToTry}...`);
            
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelToTry}:generateContent?key=${API_KEY}`;
            const p = PERSONALITIES[selectedPersonality];
            const contextString = getRelationshipContext(currentUser, selectedPersonality);
            const finalPrompt = `[SYSTEM] Identity: ${p.prompt}. Context: ${contextString}. User: ${text}`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
                });
                if (!response.ok) {
                    logMessage(`Model ${modelToTry} FAILED.`, "warn");
                    return fetchWithFallback(text, attempt + 1);
                }
                const data = await response.json();
                logMessage(`Model ${modelToTry} SUCCESS.`, "success");
                currentModel = modelToTry;
                document.getElementById('engineer-display').innerText = `RADIO: ${p.name}`;
                document.getElementById('model-input').value = currentModel;
                return data;
            } catch (error) { 
                logMessage(`Network Error: ${error.message}`, "error");
                return fetchWithFallback(text, attempt + 1); 
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            userInput.value = '';
            const loadingId = addLoadingIndicator();
            try {
                const data = await fetchWithFallback(text);
                document.getElementById(loadingId).remove();
                if (data.candidates) addMessage(data.candidates[0].content.parts[0].text, 'ai');
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addMessage("Telemetry lost.", 'error');
            }
        });

        function addMessage(text, type) {
            const div = document.createElement('div');
            let align = type === 'user' ? 'self-end items-end' : '';
            let bubble = type === 'user' ? 'msg-user' : type === 'ai' ? 'msg-ai' : 'msg-error';
            let name = type === 'user' ? currentUser : PERSONALITIES[selectedPersonality].name;
            div.className = `flex flex-col gap-2 max-w-[85%] ${align}`;
            div.innerHTML = `<div class="flex items-center gap-2 mb-1 ${type === 'user' ? 'flex-row-reverse' : ''}"><span class="text-[10px] font-mono uppercase text-gray-500">${name}</span></div><div class="${bubble} p-4 text-sm md:text-base leading-relaxed animate-fade-in">${text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>')}</div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingIndicator() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex flex-col gap-2 max-w-[80%]";
            div.innerHTML = `<div class="msg-ai p-4 w-16"><svg class="typing-dot w-2 h-2 rounded-full bg-gray-400"></svg></div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }
    </script>
</body>
</html>
